<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Home Bill Tracker</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
:root {
  --bg: #0e0e11;
  --card: #1b1b20;
  --text: #f5f5f7;
  --muted: #9a9aa0;
  --accent1: #0a84ff;
  --accent2: #ff375f;
  --danger: #ff453a;
  --radius: 18px;
}

* {
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  padding: 20px;
}

.container {
  max-width: 900px;
  margin: auto;
}

h1 {
  text-align: center;
  margin-bottom: 6px;
}

.balance {
  text-align: center;
  color: var(--muted);
  margin-bottom: 16px;
}

.card {
  background: var(--card);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 16px;
}

.chart-wrapper {
  max-width: 520px;
  margin: 0 auto;
}

canvas {
  max-height: 160px;
}

/* MONTH TABS */
.month-tabs {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  justify-content: center;
}

.month-tab {
  padding: 8px 14px;
  border-radius: 14px;
  background: #2a2a31;
  font-size: 0.85rem;
  cursor: pointer;
  white-space: nowrap;
}

.month-tab.active {
  background: var(--accent1);
}

/* FORM */
.form {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr auto;
  gap: 8px;
}

@media (max-width: 600px) {
  .form {
    grid-template-columns: 1fr;
  }
}

input, select {
  background: #2a2a31;
  border: none;
  border-radius: 14px;
  padding: 12px;
  color: var(--text);
  width: 100%;
}

button {
  border: none;
  border-radius: 14px;
  padding: 12px 18px;
  background: var(--accent1);
  color: white;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
}

button:active {
  opacity: 0.85;
}

/* EXPENSE LIST */
.expense {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid #2a2a31;
}

.expense-left {
  display: flex;
  align-items: center;
  gap: 8px;
}

.logo {
  width: 20px;
  height: 20px;
  border-radius: 4px;
}

.actions {
  display: flex;
  gap: 10px;
}

.action {
  font-size: 0.8rem;
  cursor: pointer;
}

.action.delete {
  color: var(--danger);
}

/* PROFILES */
.profiles {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 24px;
  margin-top: 12px;
  margin-bottom: 16px;
}

.profile {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  border: 3px solid transparent;
  cursor: pointer;
}

.profile.active {
  border-color: var(--accent1);
}

/* EXPORT/IMPORT BUTTONS */
.export {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px; /* Gap between buttons */
}

.export button {
  display: flex; /* Allows icon and text to be on the same line and align */
  align-items: center;
  justify-content: center; /* This will center the icon and text horizontally */
  gap: 8px; /* Gap between icon and text */
}

/* Auto-suggestion Styles */
.note-input-wrapper {
  position: relative; /* Crucial for positioning the dropdown */
}

.suggestions-dropdown {
  position: absolute;
  top: calc(100% + 5px); /* Position below the input + a small gap */
  left: 0;
  right: 0;
  background: var(--card);
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
  max-height: 120px;
  overflow-y: auto;
  z-index: 100; /* Ensure it's above other elements */
  display: none; /* Hidden by default */
  width: 100%; /* Ensure it spans the width of the input */
}

.suggestions-dropdown div {
  padding: 8px 12px;
  cursor: pointer;
}

.suggestions-dropdown div:hover {
  background: #2a2a31;
}
</style>
</head>

<body>
<div class="container">

<h1>Bills Overview</h1>
<div class="balance" id="balanceText"></div>

<div class="profiles">
  <img src="assets/person001.png" id="francisBtn" class="profile active" onclick="selectPerson('francis')">
  <img src="assets/person002.png" id="fionaBtn" class="profile" onclick="selectPerson('fiona')">
</div>

<div class="card">
  <div class="chart-wrapper">
    <canvas id="billChart"></canvas>
  </div>
</div>

<div class="card">
  <div class="month-tabs" id="monthTabs"></div>
</div>

<div class="card">
  <div class="form">
    <input id="amountInput" type="number" step="0.01" placeholder="£ amount">
    <div class="note-input-wrapper">
      <input id="noteInput" type="text" placeholder="Description or brand">
      <div id="suggestions" class="suggestions-dropdown"></div>
    </div>
    <select id="recurringInput">
      <option value="no">One-off</option>
      <option value="yes">Recurring</option>
    </select>
    <button onclick="addExpense()">Add</button>
  </div>
</div>

<div class="card">
  <strong id="expenseTitle"></strong>
  <div id="expenseList"></div>
</div>

<div class="card export">
  <button onclick="importJSON()">
    <i class="fa-solid fa-file-arrow-up"></i> Import JSON
  </button>
  <button onclick="exportJSON()">
    <i class="fa-solid fa-file-arrow-down"></i> Export JSON
  </button>
</div>

</div>

<script>
const MONTHS = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];

// Updated BRAND_LOGOS mapping to local image paths
const BRAND_LOGOS = {
  "affinity water": "assets/logos/affinitywater.png",
  "amazon": "assets/logos/amazon.png",
  "costco": "assets/logos/costco.png",
  "hyperoptic": "assets/logos/hyperoptic.png",
  "insite energy": "assets/logos/insiteenergy.png",
  "lidl": "assets/logos/lidl.png",
  "lner": "assets/logos/lner.png",
  "octopus energy": "assets/logos/octopusenergy.png",
  "sainsbury's": "assets/logos/sainsburys.png",
  "m&s": "assets/logos/mands.png",
  "b&q": "assets/logos/bandq.png",
  "eurostar": "assets/logos/eurostar.png",
  "council-tax": "assets/logos/brent.png",
  "hotel/accomodation": "assets/logos/booking.png",
};

// DOM elements for suggestions
const noteInput = document.getElementById('noteInput');
const suggestionsDiv = document.getElementById('suggestions');

// Auto-suggestion functions
function showSuggestions() {
  const inputValue = noteInput.value.toLowerCase();
  suggestionsDiv.innerHTML = ''; // Clear previous suggestions

  // Only show suggestions if there's input or if the input is focused and the dropdown is not explicitly hidden
  if (inputValue.length === 0 && document.activeElement !== noteInput) {
    suggestionsDiv.style.display = 'none';
    return;
  }

  const matchingBrands = Object.keys(BRAND_LOGOS).filter(brand =>
    brand.includes(inputValue)
  ).sort(); // Sort alphabetically

  if (matchingBrands.length > 0) {
    matchingBrands.forEach(brand => {
      const suggestionItem = document.createElement('div');
      suggestionItem.textContent = brand.charAt(0).toUpperCase() + brand.slice(1); // Capitalize for display
      suggestionItem.onmousedown = (event) => { // Use mousedown and preventDefault
        event.preventDefault(); // Prevents the input from losing focus
        selectSuggestion(brand);
      };
      suggestionsDiv.appendChild(suggestionItem);
    });
    suggestionsDiv.style.display = 'block';
  } else {
    suggestionsDiv.style.display = 'none';
  }
}

function selectSuggestion(brandName) {
  noteInput.value = brandName.charAt(0).toUpperCase() + brandName.slice(1); // Set input to selected capitalized brand
  suggestionsDiv.style.display = 'none';
  // No need to call focus() here, as preventDefault on mousedown kept focus
}

function hideSuggestions() {
  // Delay hiding to allow click events on suggestions to register
  setTimeout(() => {
    // Only hide if the input does not have focus AND the dropdown itself is not focused
    if (document.activeElement !== noteInput && !suggestionsDiv.contains(document.activeElement)) {
      suggestionsDiv.style.display = 'none';
    }
  }, 100);
}

// Attach event listeners
noteInput.addEventListener('input', showSuggestions);
noteInput.addEventListener('focus', showSuggestions); // Show suggestions if input is focused and has text
noteInput.addEventListener('blur', hideSuggestions);


function normalizeMonthKey(monthKey) {
  if (monthKey && monthKey.match(/^\d{4}-\d{2}$/)) { // e.g., "2026-01"
    const [year, monthNum] = monthKey.split('-');
    const monthIndex = parseInt(monthNum, 10) - 1; // 0-indexed month
    if (monthIndex >= 0 && monthIndex < 12) {
      return `${year}-${MONTHS[monthIndex]}`;
    }
  }
  return monthKey; // Return as is if already correct or unparseable
}

function currentMonthKey() {
  const d = new Date();
  return `${d.getFullYear()}-${MONTHS[d.getMonth()]}`;
}

let activePerson = "francis";
let activeMonth = currentMonthKey();

const data = JSON.parse(localStorage.getItem("billData")) || {
  francis: [],
  fiona: []
};

// Migrate old month formats to the new YYYY-MMM format on load
function migrateData() {
  let changed = false;
  ["francis", "fiona"].forEach(p => {
    data[p].forEach(e => {
      const normalized = normalizeMonthKey(e.month);
      if (normalized !== e.month) {
        e.month = normalized;
        changed = true;
      }
    });
  });
  if (changed) {
    save(); // Save the migrated data back to localStorage
    console.log("Migrated old month formats in localStorage.");
  }
}
migrateData(); // Run migration once on script load

function save() {
  localStorage.setItem("billData", JSON.stringify(data));
}

function capitalise(name) {
  return name.charAt(0).toUpperCase() + name.slice(1);
}

// Updated detectLogo to use BRAND_LOGOS for local paths
function detectLogo(note) {
  const lowerCaseNote = note.toLowerCase();
  for (const brand in BRAND_LOGOS) {
    if (lowerCaseNote.includes(brand)) {
      return BRAND_LOGOS[brand];
    }
  }
  return null;
}

function getMonths() {
  const set = new Set();
  set.add(normalizeMonthKey(activeMonth)); // Ensure activeMonth is also normalized when added

  ["francis","fiona"].forEach(p =>
    data[p].forEach(e => set.add(normalizeMonthKey(e.month))) // Normalize all stored months
  );
  // Sort months chronologically for display
  return [...set].sort((a, b) => {
    const [yearA, monthA] = a.split('-');
    const [yearB, monthB] = b.split('-');
    if (yearA !== yearB) return parseInt(yearA) - parseInt(yearB);
    return MONTHS.indexOf(monthA) - MONTHS.indexOf(monthB);
  });
}

function renderMonths() {
  monthTabs.innerHTML = "";
  getMonths().forEach(m => {
    const tab = document.createElement("div");
    tab.className = "month-tab" + (m === activeMonth ? " active" : "");
    tab.textContent = m;
    tab.onclick = () => { activeMonth = m; applyRecurring(); updateAll(); };
    monthTabs.appendChild(tab);
  });
}

function applyRecurring() {
  ["francis","fiona"].forEach(p => {
    data[p].filter(e => e.recurring).forEach(e => {
      // Use normalizeMonthKey for comparison to handle any edge cases
      if (!data[p].some(x => x.baseId === e.baseId && normalizeMonthKey(x.month) === activeMonth)) {
        // Create a copy and ensure the month is set to the current activeMonth format
        data[p].push({ ...e, month: activeMonth });
      }
    });
  });
}

function total(person) {
  return data[person]
    .filter(e => normalizeMonthKey(e.month) === activeMonth) // Normalize month for filtering
    .reduce((s,e) => s + e.amount, 0);
}

function updateBalance() {
  const a = total("francis");
  const b = total("fiona");
  const diff = Math.abs(a - b) / 2;
  balanceText.textContent =
    a === b ? "All settled" :
    a > b ? `Fiona owes Francis £${diff.toFixed(2)}` :
            `Francis owes Fiona £${diff.toFixed(2)}`;
}

function renderExpenses() {
  expenseTitle.textContent = `${capitalise(activePerson)} – ${activeMonth}`;
  expenseList.innerHTML = "";

  data[activePerson]
    .filter(e => normalizeMonthKey(e.month) === activeMonth) // Normalize month for filtering
    .forEach((e,i) => {
      const row = document.createElement("div");
      row.className = "expense";
      // The logo is displayed if e.logo exists
      const logo = e.logo ? `<img class="logo" src="${e.logo}" onerror="this.remove()">` : "";
      row.innerHTML = `
        <div class="expense-left">
          ${logo}
          <div>${e.note}<br><small>£${e.amount.toFixed(2)}</small></div>
        </div>
        <div class="actions">
          <span class="action" onclick="editExpenseAtIndex(${data[activePerson].indexOf(e)})"><i class="fa-solid fa-pencil"></i></span>
          <span class="action delete" onclick="deleteExpenseAtIndex(${data[activePerson].indexOf(e)})"><i class="fa-solid fa-trash"></i></span>
        </div>
      `;
      expenseList.appendChild(row);
    });
}

function addExpense() {
  const amount = parseFloat(amountInput.value);
  const note = noteInput.value.trim();
  if (!amount || !note) return;

  data[activePerson].push({
    baseId: crypto.randomUUID(),
    month: activeMonth, // activeMonth is already in YYYY-MMM format
    amount,
    note,
    logo: detectLogo(note), // detect logo based on the note
    recurring: recurringInput.value === "yes"
  });

  amountInput.value = "";
  noteInput.value = "";
  suggestionsDiv.style.display = 'none'; // Hide suggestions after adding expense
  save();
  updateAll();
}

// Renamed to avoid confusion, using original index for data manipulation
function editExpenseAtIndex(originalIndex) {
  const e = data[activePerson][originalIndex];
  const n = prompt("Description", e.note);
  const a = prompt("Amount", e.amount);
  if (!n || !a) return;
  e.note = n;
  e.amount = parseFloat(a);
  e.logo = detectLogo(n); // Re-detect logo in case description changed
  save();
  updateAll();
}

// Renamed to avoid confusion, using original index for data manipulation
function deleteExpenseAtIndex(originalIndex) {
  if (!confirm("Delete expense?")) return;
  data[activePerson].splice(originalIndex,1);
  save();
  updateAll();
}

function selectPerson(p) {
  activePerson = p;
  francisBtn.classList.toggle("active", p === "francis");
  fionaBtn.classList.toggle("active", p === "fiona");
  renderExpenses();
}

const chart = new Chart(document.getElementById("billChart"), {
  type: "bar",
  data: {
    labels: ["Francis", "Fiona"],
    datasets: [{
      data: [0,0],
      backgroundColor: ["#0a84ff","#ff375f"]
    }]
  },
  options: {
    indexAxis: "y",
    plugins: { legend: { display: false } },
    scales: {
      x: { ticks: { color: "#f5f5f7" }, grid: { color: "#2a2a31" } },
      y: { ticks: { color: "#f5f5f7" }, grid: { display: false } }
    },
    elements: { // Added for rounded bar corners
      bar: {
        borderRadius: {
          topRight: 12, // Round the top-right corner
          bottomRight: 12 // Round the bottom-right corner
        }
      }
    }
  }
});

function updateChart() {
  chart.data.datasets[0].data = [total("francis"), total("fiona")];
  chart.update();
}

function exportJSON() {
  const blob = new Blob([JSON.stringify(data,null,2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "home-bills.json";
  a.click();
}

function importJSON() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json'; // Only accept JSON files

  input.onchange = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const importedData = JSON.parse(e.target.result);
          // Basic validation: Check if it looks like our data structure
          if (importedData.francis && Array.isArray(importedData.francis) &&
              importedData.fiona && Array.isArray(importedData.fiona)) {
            if (confirm("Are you sure you want to import this data? This will overwrite your current data.")) {
              data.francis = importedData.francis;
              data.fiona = importedData.fiona;
              save();
              migrateData(); // Run migration on imported data too, to ensure consistency
              updateAll();
              alert("Data imported successfully!");
            }
          } else {
            alert("Invalid JSON file format. Please ensure it's a valid Home Bill Tracker export.");
          }
        } catch (error) {
          alert("Error parsing JSON file: " + error.message);
          console.error("Error parsing JSON file:", error);
        }
      };
      reader.readAsText(file);
    }
  };

  input.click(); // Programmatically click the hidden file input to open file dialog
}


function updateAll() {
  renderMonths();
  applyRecurring(); // Ensure recurring expenses are applied *after* data migration and before totals are calculated
  updateChart();
  updateBalance();
  renderExpenses();
}

// Initial update call
updateAll();
</script>
</body>
</html>
